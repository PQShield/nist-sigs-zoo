<!DOCTYPE html>

<div id="container"></div>

<script src="static/d3.v7.min.js"></script>
<style>
  table,
  th,
  td {
    border: 1px solid;
  }
</style>

<ul id="categories"></ul>

<table id="scheme-table">
  <thead></thead>
  <tbody></tbody>
</table>

<table id="properties-table">
  <thead></thead>
  <tbody></tbody>
</table>

<script type="module" type="application/javascript">
    const schemes = await d3.csv("data/schemes.csv", (d) => {
        return {
            Scheme: d.Scheme,
            Status: d["NIST status"],
            Website: d.Website,
            Category: d.Category,
            Assumption: d.Assumption,
        };
    });
    const properties = await d3.csv("data/parametersets.csv", (d) => {
        return {
          Scheme: d.Scheme,
          Parameterset: d.Parameterset,
          Level: +d["Security level"],
          Pk: +d["pk size"].replace(/,/g, ''),
          Sig: +d["sig size"].replace(/,/g, ''),
        };
    });
    const categories = new Set(schemes.map((s) => s.Category));


    const table = d3.select('#scheme-table');
    const propsTable = d3.select("#properties-table");

  // headers
  table.select("thead")
    .append("tr")
    .selectAll("th")
    .data(["Include", "Scheme", "Status", "Category", "Assumption"])
    .enter()
    .append("th")
    .text(d => d);

  propsTable
    .select("thead")
    .append("tr")
    .selectAll("th")
    .data(["Scheme", "Parameterset", "NIST level", "Public key bytes", "Signature bytes"])
    .enter()
    .append("th")
    .text(d=>d);

  function updateTable(event) {
    const selectedCategories = d3
      .selectAll(".category > input:checked")
      .select(function() { return this.parentNode })
      .data();

    // data
    const rows = table
      .select("tbody")
      .selectAll("tr")
      .data(
        schemes.filter((s) => selectedCategories.includes(s.Category)),
        (d) => d.Scheme,
      )
      .join(
        (enter) => enter.append((d) => {
          const row = d3.create("tr")
            .property("data-scheme", d.Scheme);
          row.append("td")
            .append("input")
            .attr("type", "checkbox")
            .attr("name", d.Scheme)
            .classed("scheme-checkbox", true)
            .on("click", updateTable)
            .property("checked", true);
          row
            .append("td")
            .append("a")
            .attr("href", d.Website)
            .attr("target", "_blank")
            .text(d.Scheme);
          row.append("td").text(d.Status);
          row.append("td").text(d.Category);
          row.append("td").text(d.Assumption);

          return row.node();
        })
      );


    let selectedSchemes = schemes.map((d) => d.Scheme);
    if (event !== undefined) {
      selectedSchemes = d3
        .selectAll("#scheme-table input:checked")
        .select(function() { return this.parentNode.parentNode })
        .data()
        .map((d) => d.Scheme);
    }
    console.log(selectedSchemes);

      const propRows = propsTable
        .select("tbody")
        .selectAll("tr")
        .data(
          properties.filter(p => selectedSchemes.includes(p.Scheme)),
          (d) => d.Scheme + d.Parameterset
        )
        .join(
          (enter) => enter.append((d) => {
            const row =d3.create("tr");

            row.append("td").text(d.Scheme);
            row.append("td").text(d.Parameterset);
            row.append("td").text(d.Level);
            row.append("td").text(d.Pk.toLocaleString())
            row.append("td").text(d.Sig.toLocaleString())

            return row.node();
          })
        );
    }

    d3.select("#categories")
    .selectAll("div")
    .data(categories)
    .enter()
    .append((d) => {
      const cat = d3.create("div").classed("category", true);
      cat
        .append("input")
        .attr("type", "checkbox")
        .attr("name", d)
        .property("checked", "checked")
        .on("click", updateTable);
      cat.append("label")
        .property("for", d)
        .text(d);
      return cat.node();
    });


    updateTable();
</script>
